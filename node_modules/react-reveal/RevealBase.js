"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _defineProperty2=require("babel-runtime/helpers/defineProperty"),_defineProperty3=_interopRequireDefault(_defineProperty2),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_extends3=require("babel-runtime/helpers/extends"),_extends4=_interopRequireDefault(_extends3),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_globals=require("./globals"),_throttle=require("./throttle"),_throttle2=_interopRequireDefault(_throttle),inOut=(0,_propTypes.shape)({make:_propTypes.func,duration:_propTypes.number.isRequired,delay:_propTypes.number.isRequired,forever:_propTypes.bool,count:_propTypes.number.isRequired,style:_propTypes.object.isRequired,reverse:_propTypes.bool}),propTypes={collapse:(0,_propTypes.oneOfType)([_propTypes.bool,(0,_propTypes.shape)({height:_propTypes.string})]),cascade:_propTypes.bool,wait:_propTypes.number,force:_propTypes.bool,disabled:_propTypes.bool,appear:_propTypes.bool,enter:_propTypes.bool,exit:_propTypes.bool,fraction:_propTypes.number,onReveal:_propTypes.func,refProp:_propTypes.string,innerRef:_propTypes.func,onExited:_propTypes.func,inEffect:inOut.isRequired,outEffect:(0,_propTypes.oneOfType)([inOut,(0,_propTypes.oneOf)([!1])]).isRequired},defaultProps={fraction:.2,refProp:"ref"},contextTypes={transitionGroup:_propTypes.object},RevealBase=function(e){function t(e,i){(0,_classCallCheck3.default)(this,t);var s=(0,_possibleConstructorReturn3.default)(this,(t.__proto__||(0,_getPrototypeOf2.default)(t)).call(this,e,i));return s.isOn=!("when"in e)||!!e.when,s.state={style:(0,_extends4.default)({},e.collapse?t.getInitialCollapseStyle(e):void 0,{opacity:!s.isOn&&e.outEffect?0:void 0})},s.savedChild=!1,s.isListener=!1,s.isShown=!1,s.revealHandler=(0,_throttle2.default)(s.reveal.bind(s,!1),66),s.resizeHandler=(0,_throttle2.default)(s.resize.bind(s),500),s.saveRef=s.saveRef.bind(s),s}return(0,_inherits3.default)(t,e),(0,_createClass3.default)(t,[{key:"saveRef",value:function(e){this.el=e,this.childRef&&this.childRef(e),this.props.innerRef&&this.props.innerRef(e)}},{key:"inViewport",value:function(){if(!this.el||window.document.hidden)return!1;var e=this.el.offsetHeight,i=window.pageYOffset-t.getTop(this.el),s=Math.min(e,window.innerHeight)*(_globals.globalHide?this.props.fraction:0);return i>s-window.innerHeight&&i<e-s}},{key:"hide",value:function(){this.props.outEffect&&this.setState({style:{opacity:0}})}},{key:"resize",value:function(){this&&this.el&&this.isOn&&this.inViewport()&&(this.unlisten(),this.isShown=this.isOn,this.setState({style:{opacity:this.isOn||!this.props.outEffect?1:0}}),this.onReveal(this.props))}},{key:"invisible",value:function(){this&&this.el&&(this.savedChild=!1,this.isShown||(this.setState({style:(0,_extends4.default)({},this.state.style,{visibility:"hidden"})}),this.props.collapse&&window.document.dispatchEvent(_globals.collapseend)),this.props.onExited&&this.props.onExited(this.el))}},{key:"animationEnd",value:function(e,t,i){var s=this,o=i.forever,n=i.count,r=i.delay,a=i.duration;if(!o){var l=function(){s&&s.el&&(s.animationEndTimeout=void 0,e.call(s))};this.animationEndTimeout=window.setTimeout(l,r+(a+(t?a:0)*n))}}},{key:"collapse",value:function(e,t,i){if(t.collapse&&t.outEffect){var s=i.duration+(t.cascade?i.duration:0),o=s>>2,n=o>>1,r=o,a=i.delay+(this.isOn?0:s-o-n),l=s-o+(this.isOn?n:-n)+"ms",p=i.delay+(this.isOn?o-n:0)+"ms",h=this.isOn?!0!==t.collapse&&"height"in t.collapse?t.collapse.height:this.dummyEl&&this.dummyEl.offsetHeight||!1:0,d=this.isOn?this.dummyEl&&window.getComputedStyle(this.dummyEl,null).getPropertyValue("padding")||!1:0,u=this.isOn?this.dummyEl&&window.getComputedStyle(this.dummyEl,null).getPropertyValue("border")||!1:0;if(!1!==h)return(0,_extends4.default)({},e,{height:h,padding:d,border:u,transition:"height "+r+"ms ease "+a+"ms, padding "+r+"ms ease "+a+"ms, border "+r+"ms ease "+a+"ms",animationDuration:l,animationDelay:p,boxSizing:"border-box"})}return e}},{key:"animate",value:function(e){if(this&&this.el&&(this.unlisten(),this.isShown!==this.isOn)){this.isShown=this.isOn;var t=!this.isOn&&e.outEffect,i=e[t?"outEffect":"inEffect"],s="style"in i&&i.style.animationName||void 0;(e.outEffect||this.isOn)&&i.make&&(s=i.make()),this.setState({style:this.collapse((0,_extends4.default)({},i.style,{animationDuration:i.duration+"ms",animationDelay:i.delay+"ms",animationIterationCount:i.forever?"infinite":i.count,opacity:1,animationName:s}),e,i),className:i.className}),t?(this.savedChild=_react2.default.cloneElement(this.getChild()),this.animationEnd(this.invisible,e.cascade,i)):this.savedChild=!1,this.onReveal(e)}}},{key:"onReveal",value:function(e){e.onReveal&&this.isOn&&(this.onRevealTimeout&&(this.onRevealTimeout=window.clearTimeout(this.onRevealTimeout)),e.wait?this.onRevealTimeout=window.setTimeout(e.onReveal,e.wait):e.onReveal())}},{key:"unlisten",value:function(){this.isListener&&(window.removeEventListener("scroll",this.revealHandler),window.removeEventListener("orientationchange",this.revealHandler),window.document.removeEventListener("visibilitychange",this.revealHandler),window.document.removeEventListener("collapseend",this.revealHandler),window.removeEventListener("resize",this.resizeHandler),this.isListener=!1),this.onRevealTimeout&&(this.onRevealTimeout=window.clearTimeout(this.onRevealTimeout)),this.animationEndTimeout&&(this.animationEndTimeout=window.clearTimeout(this.animationEndTimeout))}},{key:"componentWillUnmount",value:function(){this.unlisten(),_globals.ssr&&(0,_globals.disableSsr)()}},{key:"listen",value:function(){this.isListener||(this.isListener=!0,window.addEventListener("scroll",this.revealHandler),window.addEventListener("orientationchange",this.revealHandler),window.document.addEventListener("visibilitychange",this.revealHandler),window.document.addEventListener("collapseend",this.revealHandler),window.addEventListener("resize",this.resizeHandler))}},{key:"reveal",value:function(e){var t=this;this&&this.el&&(e||(e=this.props),this.isOn&&this.isShown&&"spy"in e?(this.isShown=!1,this.setState({style:{}}),window.setTimeout(function(){return t.reveal(e)},200)):this.inViewport()?this.animate(e):this.listen())}},{key:"componentDidMount",value:function(){if(this.el&&!this.props.disabled){var e=this.context.transitionGroup,i=e&&!e.isMounting?!("enter"in this.props&&!1===this.props.enter):this.props.appear;return this.isOn&&(("when"in this.props||"spy"in this.props)&&!i||_globals.ssr&&!_globals.fadeOutEnabled&&this.props.outEffect&&t.getTop(this.el)<window.pageYOffset+window.innerHeight)?(this.isShown=!0,this.setState({style:{opacity:1,height:this.props.collapse?this.dummyEl.offsetHeight:void 0}}),void this.onReveal(this.props)):_globals.ssr&&_globals.fadeOutEnabled&&this.props.outEffect&&t.getTop(this.el)<window.pageYOffset+window.innerHeight?(this.setState({style:{opacity:0,transition:"opacity 1000ms 1000ms"}}),void window.setTimeout(this.revealHandler,2e3)):this.props.force?this.animate(this.props):void(this.isOn&&this.reveal(this.props))}}},{key:"cascade",value:function(e){var t=this,i=void 0;i="string"==typeof e?e.split("").map(function(e,t){return _react2.default.createElement("span",{key:t,style:{display:"inline-block",whiteSpace:"pre"}},e)}):_react2.default.Children.toArray(e);var s=this.props[this.isOn||!this.props.outEffect?"inEffect":"outEffect"],o=s.duration,n=s.reverse,r=i.length,a=2*o;this.props.collapse&&(a=parseInt(this.state.style.animationDuration,10),o=a/2);var l=n?r:0;return i=i.map(function(e){return"object"===(void 0===e?"undefined":(0,_typeof3.default)(e))&&"type"in e&&"string"==typeof e.type?_react2.default.cloneElement(e,{style:(0,_extends4.default)({},e.props.style,t.props.collapse?(0,_extends4.default)({},t.state.style,{boxSizing:void 0,height:void 0,border:void 0,padding:void 0,transition:void 0}):t.state.style,{animationDuration:Math.round((0,_globals.cascade)(n?l--:l++,0,r,o,a))+"ms"})}):e})}},{key:"componentWillReceiveProps",value:function(e){if("when"in e&&(this.isOn=!!e.when),!this.isOn&&e.onExited&&"exit"in e&&!1===e.exit)return void e.onExited();if(!e.disabled){if(e.collapse&&!this.props.collapse)return this.setState({style:t.getInitialCollapseStyle(e)}),void(this.isShown=!1);this.isOn&&!0===e.collapse&&this.dummyEl&&this.dummyEl.offsetHeight&&this.state.style.height!==this.dummyEl.offsetHeight&&this.setState({style:(0,_extends4.default)({},this.state.style,{height:this.dummyEl.offsetHeight})}),e.when===this.props.when&&e.spy===this.props.spy||this.reveal(e),this.onRevealTimeout&&!this.isOn&&(this.onRevealTimeout=window.clearTimeout(this.onRevealTimeout))}}},{key:"dummy",value:function(e,t){var i,s=this;if(!0!==this.props.collapse&&"height"in this.props.collapse)return e;var o=[e,_react2.default.createElement(e.type,(0,_extends4.default)({},e.props,(i={children:t.props.children,key:2},(0,_defineProperty3.default)(i,this.props.refProp,function(e){return s.dummyEl=e}),(0,_defineProperty3.default)(i,"style",(0,_extends4.default)({},e.props.style,{position:"absolute",top:"-9999em",height:"auto",border:this.el?this.el.border:void 0,padding:this.el?this.el.padding:void 0,animationName:"none",animationDuration:"0s",transition:"none",opacity:0})),i)))];return _globals.is16?o:_react2.default.createElement("span",null,o)}},{key:"getChild",value:function(){if(this.savedChild&&!this.props.disabled)return this.savedChild;if("object"===(0,_typeof3.default)(this.props.children)){var e=_react2.default.Children.only(this.props.children);return"type"in e&&"string"==typeof e.type||"ref"!==this.props.refProp?e:_react2.default.createElement("div",null,e)}return _react2.default.createElement("div",null,this.props.children)}},{key:"render",value:function(){var e=this.getChild();"function"==typeof e.ref&&(this.childRef=e.ref);var t=!1,i=e.props,s=i.style,o=i.className,n=i.children,r=this.props.disabled?o:(this.props.outEffect?_globals.namespace:"")+(this.state.className?" "+this.state.className:"")+(o?" "+o:"")||void 0,a=this.props.disabled?s:(0,_extends4.default)({},s,this.state.style);this.props.cascade&&!this.props.disabled&&n&&this.state.style.animationName&&(t=this.cascade(n),a.animationName=void 0);var l=(0,_extends4.default)({},this.props.props,(0,_defineProperty3.default)({className:r,style:a},this.props.refProp,this.saveRef));this.props.collapse&&!this.props.disabled&&(l.key=1);var p=_react2.default.cloneElement(e,l,t||n);return this.props.collapse&&!this.props.disabled?this.dummy(p,e):p}}],[{key:"getTop",value:function(e){for(;void 0===e.offsetTop;)e=e.parentNode;for(var t=e.offsetTop;e.offsetParent;t+=e.offsetTop)e=e.offsetParent;return t}},{key:"getInitialCollapseStyle",value:function(e){return{visibility:e.when||!e.outEffect?"visible":"hidden",height:0,padding:0,border:0,boxSizing:"border-box"}}}]),t}(_react2.default.Component);RevealBase.propTypes=propTypes,RevealBase.defaultProps=defaultProps,RevealBase.contextTypes=contextTypes,RevealBase.displayName="RevealBase",exports.default=RevealBase,module.exports=exports.default;